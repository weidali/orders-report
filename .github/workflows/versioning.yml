name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

on:
  push:
    branches: [ master ]
    paths:
      - '**.js'
      - '**.html'
      - '**.css'
      - '!version.json'
      - '!package.json'

jobs:
  update-version-and-tag:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
    - name: ‚¨áÔ∏è Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Node.js
    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # –®–∞–≥ 3: –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
    - name: üìã Get current version
      id: current_version
      run: |
        CURRENT_VERSION=$(node -e "console.log(require('./version.json').version)")
        echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $CURRENT_VERSION"
        echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV

    # –®–∞–≥ 4: –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é (patch)
    - name: üîÑ Update version
      run: |
        npm run version:patch
        NEW_VERSION=$(node -e "console.log(require('./version.json').version)")
        echo "–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: $NEW_VERSION"
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

    # –®–∞–≥ 5: –ö–æ–º–º–∏—Ç–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
    - name: üíæ Commit version update
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add version.json index.html package.json
        git commit -m "chore: auto-update version to v$NEW_VERSION [skip ci]"
        
        echo "‚úÖ –í–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ v$NEW_VERSION"

    # –®–∞–≥ 6: –°–æ–∑–¥–∞–µ–º —Ç–µ–≥
    - name: üè∑Ô∏è Create git tag
      run: |
        git tag -a "v$NEW_VERSION" -m "Release version v$NEW_VERSION"
        echo "‚úÖ –¢–µ–≥ v$NEW_VERSION —Å–æ–∑–¥–∞–Ω"

    # –®–∞–≥ 7: –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —Ç–µ–≥
    - name: üì§ Push changes and tag
      run: |
        git push origin master
        git push origin "v$NEW_VERSION"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # –®–∞–≥ 8: –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑
    - name: üéâ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.NEW_VERSION }}
        name: Release v${{ env.NEW_VERSION }}
        body: |
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–ª–∏–∑ –≤–µ—Ä—Å–∏–∏ v${{ env.NEW_VERSION }}
          
          ### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
          - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –º–µ—Ä–∂–µ –≤ master
          - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}